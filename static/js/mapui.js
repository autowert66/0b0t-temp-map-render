const MCTileLayer=L.TileLayer.extend({initialize:function(t,e){this._url=t,this._imageFormat=e.imageFormat,L.setOptions(this,e)},getTileUrl:function(t){const e=this._map.getZoom();let i=this._url;if(t.x<0||t.x>=Math.pow(2,e)||t.y<0||t.y>=Math.pow(2,e))i+="/blank";else if(e===0)i+="/base";else for(let o=e-1;o>=0;--o){let n=Math.floor(t.x/Math.pow(2,o))%2,a=Math.floor(t.y/Math.pow(2,o))%2;i+="/"+(n+2*a+1)}return i=i+"."+this._imageFormat,i}});function createMCTileLayer(t,e,i){let o=typeof MAP_CDN<"u"?MAP_CDN:"";return o+=t+"/",o+=["tl","tr","br","bl"][i],new MCTileLayer(o,{maxZoom:e.maxZoom,tileSize:e.tileSize,noWrap:!0,continuousWorld:!0,imageFormat:e.imageFormat})}const IsometricRenderView={mcToLatLng:function(t,e,i,o,n,a,r){const l=n.tileSize*Math.pow(2,n.maxZoom),s=n.textureSize/2,p=L.point(2*(t+e),e-t+(256-i)*2).multiplyBy(s).add(L.point(l/2,l/2)).add(L.point(-n.textureSize*16,0)).add(L.point(-a[0],-a[1]).multiplyBy(n.tileSize));return o.unproject(p,n.maxZoom)},latLngToMC:function(t,e,i,o,n,a){const r=o.tileSize*Math.pow(2,o.maxZoom),l=o.textureSize/2,s=i.project(t,o.maxZoom).add(L.point(n[0],n[1]).multiplyBy(o.tileSize)).add(L.point(o.textureSize*16,0)).add(L.point(-r/2,-r/2));s.x/=2*l,s.y/=l;const p=.5*(s.x-s.y-2*e+512),c=.5*(s.x+s.y+2*e-512);return[p,c,e]}},TopdownRenderView={mcToLatLng:function(t,e,i,o,n,a,r){const l=n.tileSize*Math.pow(2,n.maxZoom),s=n.tileSize/(16*r),p=L.point(t,e).multiplyBy(s).add(L.point(l/2,l/2)).add(L.point(-a[0],-a[1]).multiplyBy(n.tileSize));return o.unproject(p,n.maxZoom)},latLngToMC:function(t,e,i,o,n,a){const r=o.tileSize*Math.pow(2,o.maxZoom),l=o.tileSize/(16*a),s=i.project(t,o.maxZoom).add(L.point(n[0],n[1]).multiplyBy(o.tileSize)).add(L.point(-r/2,-r/2)).divideBy(l);return[s.x,s.y,e]}};function MapUI(t){this.config=t,this.currentMap=null,this.currentRotation=null,this.lmap=null,this.layers={},this.handlers=[],this.controlsNotCreated=[],this.handlersNotCreated=[],this.created=!1;const e=new PosHashHandler;this.addHandler(e),window.addEventListener("hashchange",()=>{if(Math.abs(Date.now()-e.lastUpdate)<1e3)return;const o=e.parseHash();e.gotoHash(o)})}MapUI.prototype.init=function(){this.lmap=L.map("mcmap",{crs:L.CRS.Simple}).setView([0,0],0,{animate:!1}),this.lmap.attributionControl.setPrefix("");let t=null;for(const e of this.config.mapsOrder){const i=this.config.maps[e];this.layers[e]={};for(const o of i.rotations)this.layers[e][o]=createMCTileLayer(e,i,o),t===null&&(t=e)}this.setMap(t),this.created=!0;for(const e of this.controlsNotCreated)this.addControl(e[0],e[1],e[2]);for(const e of this.handlersNotCreated)this.addHandler(e);this.controlsNotCreated=[],this.handlersNotCreated=[]},MapUI.prototype.getCurrentMap=function(){return this.currentMap},MapUI.prototype.getCurrentRotation=function(){return this.currentRotation},MapUI.prototype.getTileSetGroupConfig=function(t){return t in this.config.tileSetGroups?this.config.tileSetGroups[t]:null},MapUI.prototype.getMapConfigs=function(){return this.config.maps},MapUI.prototype.getMapConfigsOrder=function(){return this.config.mapsOrder},MapUI.prototype.getMapConfig=function(t){return t in this.config.maps?this.config.maps[t]:null},MapUI.prototype.getCurrentMapConfig=function(){return this.getMapConfig(this.currentMap)},MapUI.prototype.setMapAndRotation=function(t,e){const i=this.getCurrentMapConfig(),o=this.getMapConfig(t);let n=null,a=null,r=0;if(this.currentMap!==null&&this.currentRotation!==null&&(n=this.layers[this.currentMap][this.currentRotation],a=this.latLngToMC(this.lmap.getCenter(),i.worldSeaLevel),r=this.lmap.getZoom()),this.currentMap=t,this.currentRotation=parseInt(e),n!==null&&this.lmap.removeLayer(n),this.lmap.addLayer(this.layers[this.currentMap][this.currentRotation]),n==null||i.world!==o.world){let l=0;if("defaultZoom"in o&&(l=o.defaultZoom),"defaultView"in o){const s=o.defaultView[0],p=o.defaultView[1],c=o.defaultView[2];this.lmap.setView(this.mcToLatLng(s,p,c),l,{animate:!1})}else{const s=o.tileSize/2;this.lmap.setView(this.lmap.unproject([s,s]),l,{animate:!1})}}else this.lmap.setView(this.mcToLatLng(a[0],a[1],a[2]),r,{animate:!1});for(const l of this.handlers)l.onMapChange(this.currentMap,this.currentRotation)},MapUI.prototype.setMap=function(t){const e=this.getCurrentMapConfig(),i=this.getMapConfig(t);if((e==null?!1:e.world===i.world)&&i.rotations.indexOf(this.currentRotation)!==-1)this.setMapAndRotation(t,this.currentRotation);else{let n=-1;"defaultRotation"in i&&(n=i.defaultRotation),i.rotations.includes(n)||(n=i.rotations[0]),this.setMapAndRotation(t,n)}},MapUI.prototype.setMapRotation=function(t){this.setMapAndRotation(this.currentMap,t)},MapUI.prototype.addControl=function(t,e,i){if(!this.created){this.controlsNotCreated.push([t,e,i]);return}const o=this,n=L.Control.extend({onAdd:function(a){const r=document.createElement("div");return t.usePanelWrapper()?(r.classList.add("control-wrapper","control-wrapper-panel","panel","panel-default"),r.id="control-wrapper-"+t.getName()):(r.classList.add("control-wrapper","control-wrapper-invisible"),r.id="control-wrapper-"+t.getName()),r.onmouseover=()=>{a.dragging.disable()},r.onmouseout=()=>{a.dragging.enable()},t.ui=o,t.create(r),r.index=i,r}});this.lmap.addControl(new n({position:e})),t.getHandler()&&this.addHandler(t.getHandler())},MapUI.prototype.addHandler=function(t){if(!this.created){this.handlersNotCreated.push(t);return}t.ui=this,t.create(),t.onMapChange(this.currentMap,this.currentRotation),this.handlers.push(t)},MapUI.prototype.mcToLatLng=function(t,e,i){const o=this.getCurrentMapConfig(),n=this.getTileSetGroupConfig(o.tileSetGroup),a=n.tileOffsets[this.currentRotation],r=n.tileWidth;for(let p=0;p<this.currentRotation;p++){var l=-e+512,s=t;t=l,e=s}return o.renderView==="isometric"?IsometricRenderView.mcToLatLng(t,e,i,this.lmap,o,a,r):TopdownRenderView.mcToLatLng(t,e,i,this.lmap,o,a,r)},MapUI.prototype.latLngToMC=function(t,e){const i=this.getCurrentMapConfig(),o=this.getTileSetGroupConfig(i.tileSetGroup),n=o.tileOffsets[this.currentRotation],a=o.tileWidth;let r;i.renderView==="isometric"?r=IsometricRenderView.latLngToMC(t,e,this.lmap,i,n,a):r=TopdownRenderView.latLngToMC(t,e,this.lmap,i,n,a);let l=r[0],s=r[1];for(let p=0;p<this.currentRotation;p++){const c=s,u=-l+512;l=c,s=u}return[l,s,e]};
